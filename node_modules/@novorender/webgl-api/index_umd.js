!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).NovoRender={})}(this,(function(t){"use strict";const e=Symbol("Comlink.proxy"),i=Symbol("Comlink.endpoint"),s=Symbol("Comlink.releaseProxy"),a=Symbol("Comlink.thrown"),r=t=>"object"==typeof t&&null!==t||"function"==typeof t,n=new Map([["proxy",{canHandle:t=>r(t)&&t[e],serialize(t){const{port1:e,port2:i}=new MessageChannel;return o(t,e),[i,[i]]},deserialize:t=>(t.start(),c(t))}],["throw",{canHandle:t=>r(t)&&a in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function o(t,e=self){e.addEventListener("message",(function i(s){if(!s||!s.data)return;const{id:r,type:n,path:c}=Object.assign({path:[]},s.data),l=(s.data.argumentList||[]).map(v);let d;try{const e=c.slice(0,-1).reduce(((t,e)=>t[e]),t),i=c.reduce(((t,e)=>t[e]),t);switch(n){case"GET":d=i;break;case"SET":e[c.slice(-1)[0]]=v(s.data.value),d=!0;break;case"APPLY":d=i.apply(e,l);break;case"CONSTRUCT":d=f(new i(...l));break;case"ENDPOINT":{const{port1:e,port2:i}=new MessageChannel;o(t,i),d=p(e,[e])}break;case"RELEASE":d=void 0;break;default:return}}catch(t){d={value:t,[a]:0}}Promise.resolve(d).catch((t=>({value:t,[a]:0}))).then((t=>{const[s,a]=w(t);e.postMessage(Object.assign(Object.assign({},s),{id:r}),a),"RELEASE"===n&&(e.removeEventListener("message",i),h(e))}))})),e.start&&e.start()}function h(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function c(t,e){return d(t,[],e)}function l(t){if(t)throw new Error("Proxy has been released and is not useable")}function d(t,e=[],a=function(){}){let r=!1;const n=new Proxy(a,{get(i,a){if(l(r),a===s)return()=>g(t,{type:"RELEASE",path:e.map((t=>t.toString()))}).then((()=>{h(t),r=!0}));if("then"===a){if(0===e.length)return{then:()=>n};const i=g(t,{type:"GET",path:e.map((t=>t.toString()))}).then(v);return i.then.bind(i)}return d(t,[...e,a])},set(i,s,a){l(r);const[n,o]=w(a);return g(t,{type:"SET",path:[...e,s].map((t=>t.toString())),value:n},o).then(v)},apply(s,a,n){l(r);const o=e[e.length-1];if(o===i)return g(t,{type:"ENDPOINT"}).then(v);if("bind"===o)return d(t,e.slice(0,-1));const[h,c]=u(n);return g(t,{type:"APPLY",path:e.map((t=>t.toString())),argumentList:h},c).then(v)},construct(i,s){l(r);const[a,n]=u(s);return g(t,{type:"CONSTRUCT",path:e.map((t=>t.toString())),argumentList:a},n).then(v)}});return n}function u(t){const e=t.map(w);return[e.map((t=>t[0])),(i=e.map((t=>t[1])),Array.prototype.concat.apply([],i))];var i}const m=new WeakMap;function p(t,e){return m.set(t,e),t}function f(t){return Object.assign(t,{[e]:!0})}function w(t){for(const[e,i]of n)if(i.canHandle(t)){const[s,a]=i.serialize(t);return[{type:"HANDLER",name:e,value:s},a]}return[{type:"RAW",value:t},m.get(t)||[]]}function v(t){switch(t.type){case"HANDLER":return n.get(t.name).deserialize(t.value);case"RAW":return t.value}}function g(t,e,i){return new Promise((s=>{const a=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");t.addEventListener("message",(function e(i){i.data&&i.data.id&&i.data.id===a&&(t.removeEventListener("message",e),s(i.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:a},e),i)}))}var y=1e-6,b="undefined"!=typeof Float32Array?Float32Array:Array,M=Math.PI/180;function k(t){return t*M}function _(t,e){return Math.abs(t-e)<=y*Math.max(1,Math.abs(t),Math.abs(e))}function x(){var t=new b(9);return b!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function S(t,e){var i=e[0],s=e[1],a=e[2],r=e[3],n=i+i,o=s+s,h=a+a,c=i*n,l=s*n,d=s*o,u=a*n,m=a*o,p=a*h,f=r*n,w=r*o,v=r*h;return t[0]=1-d-p,t[3]=l-v,t[6]=u+w,t[1]=l+v,t[4]=1-c-p,t[7]=m-f,t[2]=u-w,t[5]=m+f,t[8]=1-c-d,t}function V(){var t=new b(16);return b!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function P(t,e){var i=e[0],s=e[1],a=e[2],r=e[3],n=e[4],o=e[5],h=e[6],c=e[7],l=e[8],d=e[9],u=e[10],m=e[11],p=e[12],f=e[13],w=e[14],v=e[15],g=i*o-s*n,y=i*h-a*n,b=i*c-r*n,M=s*h-a*o,k=s*c-r*o,_=a*c-r*h,x=l*f-d*p,S=l*w-u*p,V=l*v-m*p,P=d*w-u*f,E=d*v-m*f,T=u*v-m*w,R=g*T-y*E+b*P+M*V-k*S+_*x;return R?(R=1/R,t[0]=(o*T-h*E+c*P)*R,t[1]=(a*E-s*T-r*P)*R,t[2]=(f*_-w*k+v*M)*R,t[3]=(u*k-d*_-m*M)*R,t[4]=(h*V-n*T-c*S)*R,t[5]=(i*T-a*V+r*S)*R,t[6]=(w*b-p*_-v*y)*R,t[7]=(l*_-u*b+m*y)*R,t[8]=(n*E-o*V+c*x)*R,t[9]=(s*V-i*E-r*x)*R,t[10]=(p*k-f*b+v*g)*R,t[11]=(d*b-l*k-m*g)*R,t[12]=(o*S-n*P-h*x)*R,t[13]=(i*P-s*S+a*x)*R,t[14]=(f*y-p*M-w*g)*R,t[15]=(l*M-d*y+u*g)*R,t):null}function E(t,e,i){var s=e[0],a=e[1],r=e[2],n=e[3],o=e[4],h=e[5],c=e[6],l=e[7],d=e[8],u=e[9],m=e[10],p=e[11],f=e[12],w=e[13],v=e[14],g=e[15],y=i[0],b=i[1],M=i[2],k=i[3];return t[0]=y*s+b*o+M*d+k*f,t[1]=y*a+b*h+M*u+k*w,t[2]=y*r+b*c+M*m+k*v,t[3]=y*n+b*l+M*p+k*g,y=i[4],b=i[5],M=i[6],k=i[7],t[4]=y*s+b*o+M*d+k*f,t[5]=y*a+b*h+M*u+k*w,t[6]=y*r+b*c+M*m+k*v,t[7]=y*n+b*l+M*p+k*g,y=i[8],b=i[9],M=i[10],k=i[11],t[8]=y*s+b*o+M*d+k*f,t[9]=y*a+b*h+M*u+k*w,t[10]=y*r+b*c+M*m+k*v,t[11]=y*n+b*l+M*p+k*g,y=i[12],b=i[13],M=i[14],k=i[15],t[12]=y*s+b*o+M*d+k*f,t[13]=y*a+b*h+M*u+k*w,t[14]=y*r+b*c+M*m+k*v,t[15]=y*n+b*l+M*p+k*g,t}function T(t,e,i){var s=Math.sin(i),a=Math.cos(i),r=e[0],n=e[1],o=e[2],h=e[3],c=e[4],l=e[5],d=e[6],u=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=r*a+c*s,t[1]=n*a+l*s,t[2]=o*a+d*s,t[3]=h*a+u*s,t[4]=c*a-r*s,t[5]=l*a-n*s,t[6]=d*a-o*s,t[7]=u*a-h*s,t}function R(t,e,i){var s=e[0],a=e[1],r=e[2],n=e[3],o=s+s,h=a+a,c=r+r,l=s*o,d=s*h,u=s*c,m=a*h,p=a*c,f=r*c,w=n*o,v=n*h,g=n*c;return t[0]=1-(m+f),t[1]=d+g,t[2]=u-v,t[3]=0,t[4]=d-g,t[5]=1-(l+f),t[6]=p+w,t[7]=0,t[8]=u+v,t[9]=p-w,t[10]=1-(l+m),t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}function C(t,e){var i=e[0],s=e[1],a=e[2],r=e[4],n=e[5],o=e[6],h=e[8],c=e[9],l=e[10];return t[0]=Math.hypot(i,s,a),t[1]=Math.hypot(r,n,o),t[2]=Math.hypot(h,c,l),t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var A=function(t,e,i,s,a){var r,n=1/Math.tan(e/2);return t[0]=n/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=a&&a!==1/0?(r=1/(s-a),t[10]=(a+s)*r,t[14]=2*a*s*r):(t[10]=-1,t[14]=-2*s),t};function L(){var t=new b(3);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function O(t,e,i){var s=new b(3);return s[0]=t,s[1]=e,s[2]=i,s}function D(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function W(t,e,i,s){return t[0]=e,t[1]=i,t[2]=s,t}function j(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function z(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function I(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function H(t,e){var i=e[0]-t[0],s=e[1]-t[1],a=e[2]-t[2];return Math.hypot(i,s,a)}function U(t,e){var i=e[0],s=e[1],a=e[2],r=i*i+s*s+a*a;return r>0&&(r=1/Math.sqrt(r)),t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function N(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function F(t,e,i){var s=e[0],a=e[1],r=e[2],n=i[0],o=i[1],h=i[2];return t[0]=a*h-r*o,t[1]=r*n-s*h,t[2]=s*o-a*n,t}function q(t,e,i){var s=e[0],a=e[1],r=e[2],n=i[3]*s+i[7]*a+i[11]*r+i[15];return n=n||1,t[0]=(i[0]*s+i[4]*a+i[8]*r+i[12])/n,t[1]=(i[1]*s+i[5]*a+i[9]*r+i[13])/n,t[2]=(i[2]*s+i[6]*a+i[10]*r+i[14])/n,t}function B(t,e,i){var s=e[0],a=e[1],r=e[2];return t[0]=s*i[0]+a*i[3]+r*i[6],t[1]=s*i[1]+a*i[4]+r*i[7],t[2]=s*i[2]+a*i[5]+r*i[8],t}function K(t,e,i){var s=i[0],a=i[1],r=i[2],n=i[3],o=e[0],h=e[1],c=e[2],l=a*c-r*h,d=r*o-s*c,u=s*h-a*o,m=a*u-r*d,p=r*l-s*u,f=s*d-a*l,w=2*n;return l*=w,d*=w,u*=w,m*=2,p*=2,f*=2,t[0]=o+l+m,t[1]=h+d+p,t[2]=c+u+f,t}function G(t,e){var i=t[0],s=t[1],a=t[2],r=e[0],n=e[1],o=e[2];return Math.abs(i-r)<=y*Math.max(1,Math.abs(i),Math.abs(r))&&Math.abs(s-n)<=y*Math.max(1,Math.abs(s),Math.abs(n))&&Math.abs(a-o)<=y*Math.max(1,Math.abs(a),Math.abs(o))}var Y=z;function X(){var t=new b(4);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function $(t,e,i,s,a){return t[0]=e,t[1]=i,t[2]=s,t[3]=a,t}function Z(){var t=new b(4);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Q(t,e,i){i*=.5;var s=e[0],a=e[1],r=e[2],n=e[3],o=Math.sin(i),h=Math.cos(i);return t[0]=s*h+n*o,t[1]=a*h+r*o,t[2]=r*h-a*o,t[3]=n*h-s*o,t}function J(t,e,i){i*=.5;var s=e[0],a=e[1],r=e[2],n=e[3],o=Math.sin(i),h=Math.cos(i);return t[0]=s*h-r*o,t[1]=a*h+n*o,t[2]=r*h+s*o,t[3]=n*h-a*o,t}function tt(t,e){var i,s=e[0]+e[4]+e[8];if(s>0)i=Math.sqrt(s+1),t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{var a=0;e[4]>e[0]&&(a=1),e[8]>e[3*a+a]&&(a=2);var r=(a+1)%3,n=(a+2)%3;i=Math.sqrt(e[3*a+a]-e[3*r+r]-e[3*n+n]+1),t[a]=.5*i,i=.5/i,t[3]=(e[3*r+n]-e[3*n+r])*i,t[r]=(e[3*r+a]+e[3*a+r])*i,t[n]=(e[3*n+a]+e[3*a+n])*i}return t}L(),X();var et=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};function it(){var t=new b(2);return b!=Float32Array&&(t[0]=0,t[1]=0),t}function st(t,e,i){return t[0]=e,t[1]=i,t}function at(t,e,i){return t<e?t=e:t>i&&(t=i),t}L(),O(1,0,0),O(0,1,0),Z(),Z(),x(),it();const rt=function(){const t=x();return function(e){return S(t,e),t}}();function nt(t){let e,i,s;const[a,r,n,o,h,c,l,d,u]=t;return e=Math.asin(-at(d,-1,1)),Math.abs(d)<.9999999?(i=Math.atan2(l,u),s=Math.atan2(r,h)):(i=Math.atan2(-n,a),s=0),{x:e,y:i,z:s}}class ot{outputPosition=L();outputRotation=Z();zoomTarget;sceneVolume;camera;domElement;mouseButtonsMap={rotate:1,pan:4,orbit:2,pivot:2};fingersMap={rotate:1,pan:2,orbit:3,pivot:3};enabled=!0;autoZoomToScene=!0;constructor(t){this.domElement=t}needPointerLock=!1;connect(){this.domElement&&(this.domElement.addEventListener("click",this.preventDefault,!1),this.domElement.addEventListener("contextmenu",this.preventDefault,!1),this.domElement.addEventListener("mousedown",this.mousedown,!1),this.domElement.addEventListener("mouseup",this.mouseup,!1),this.domElement.addEventListener("mousemove",this.mousemove,!1),this.domElement.addEventListener("wheel",this.mousewheel,!1),this.domElement.addEventListener("touchstart",this.touchstart,!1),this.domElement.addEventListener("touchmove",this.touchmove,!1),this.domElement.addEventListener("touchend",this.touchend,!1),this.domElement.addEventListener("touchcancel",this.touchcancel,!1))}disconnect(){this.domElement&&(this.domElement.removeEventListener("click",this.preventDefault,!1),this.domElement.removeEventListener("contextmenu",this.preventDefault,!1),this.domElement.removeEventListener("mousedown",this.mousedown,!1),this.domElement.removeEventListener("mouseup",this.mouseup,!1),this.domElement.removeEventListener("mousemove",this.mousemove,!1),this.domElement.removeEventListener("wheel",this.mousewheel,!1),this.domElement.removeEventListener("touchstart",this.touchstart,!1),this.domElement.removeEventListener("touchmove",this.touchmove,!1),this.domElement.removeEventListener("touchend",this.touchend,!1),this.domElement.removeEventListener("touchcancel",this.touchcancel,!1))}preventDefault=t=>{t.preventDefault()};mousedown=t=>{this.camera&&this.enabled&&(this.needPointerLock=!0,t.preventDefault())};mouseup=t=>{this.camera&&this.enabled&&(t.preventDefault(),"exitPointerLock"in document&&document.exitPointerLock(),this.needPointerLock=!1)};mousewheel=t=>{this.camera&&this.enabled&&this.zoom(t.deltaY,t.offsetX,t.offsetY)};mousemove=t=>{if(this.camera&&this.enabled&&!(t.buttons<1||Math.abs(t.movementX)>100||Math.abs(t.movementY)>100))if(this.needPointerLock&&(t.currentTarget.requestPointerLock(),this.needPointerLock=!1),t.buttons&this.mouseButtonsMap.orbit){const e=x();S(e,this.outputRotation),this.orbit(t.movementX,t.movementY,e,!0)}else if(t.buttons&this.mouseButtonsMap.pan){const e=x();S(e,this.outputRotation),this.pan(t.movementX,t.movementY,e)}else t.buttons&this.mouseButtonsMap.rotate&&this.rotate(-t.movementX,-t.movementY)};pointerTable=[];_touchMovePrev=it();_touchZoomDistancePrev=0;touchstart=t=>{if(this.camera&&this.enabled)if(t.stopPropagation(),this.pointerTable=Array.from(t.touches).map((t=>({id:t.identifier,x:Math.round(t.clientX),y:Math.round(t.clientY)}))),1===this.pointerTable.length)st(this._touchMovePrev,this.pointerTable[0].x,this.pointerTable[0].y);else{const t=this.pointerTable[0].x-this.pointerTable[1].x,e=this.pointerTable[0].y-this.pointerTable[1].y;this._touchZoomDistancePrev=Math.sqrt(t*t+e*e);const i=(this.pointerTable[0].x+this.pointerTable[1].x)/2,s=(this.pointerTable[0].y+this.pointerTable[1].y)/2;st(this._touchMovePrev,i,s)}};touchend=t=>{if(this.camera&&this.enabled)switch(t.stopPropagation(),this.pointerTable=Array.from(t.touches).map((t=>({id:t.identifier,x:Math.round(t.clientX),y:Math.round(t.clientY)}))),this.pointerTable.length){case 0:break;case 1:st(this._touchMovePrev,this.pointerTable[0].x,this.pointerTable[0].y);break;default:const t=this.pointerTable[0].x-this.pointerTable[1].x,e=this.pointerTable[0].y-this.pointerTable[1].y;this._touchZoomDistancePrev=Math.sqrt(t*t+e*e);const i=(this.pointerTable[0].x+this.pointerTable[1].x)/2,s=(this.pointerTable[0].y+this.pointerTable[1].y)/2;st(this._touchMovePrev,i,s)}};touchcancel=t=>{this.camera&&this.enabled&&(t.preventDefault(),t.stopPropagation(),this.pointerTable=Array.from(t.touches).map((t=>({id:t.identifier,x:Math.round(t.clientX),y:Math.round(t.clientY)}))))};touchmove=t=>{if(!this.camera||!this.enabled)return;t.cancelable&&t.preventDefault(),this.pointerTable=Array.from(t.touches).map((t=>({id:t.identifier,x:Math.round(t.clientX),y:Math.round(t.clientY)})));let{x:e,y:i}=this.pointerTable[0];if(this.pointerTable.length>1){const t=this.pointerTable[0].x-this.pointerTable[1].x,s=this.pointerTable[0].y-this.pointerTable[1].y,a=Math.sqrt(t*t+s*s);e=(this.pointerTable[0].x+this.pointerTable[1].x)/2,i=(this.pointerTable[0].y+this.pointerTable[1].y)/2;const r=this._touchZoomDistancePrev-a;this._touchZoomDistancePrev=a,this.zoom(r,e,i)}switch(this.pointerTable.length){case this.fingersMap.rotate:this.rotate(e-this._touchMovePrev[0],i-this._touchMovePrev[1]);break;case this.fingersMap.orbit:this.orbit(this._touchMovePrev[0]-e,this._touchMovePrev[1]-i,S(x(),this.outputRotation));break;case this.fingersMap.pan:this.pan(e-this._touchMovePrev[0],i-this._touchMovePrev[1],S(x(),this.outputRotation))}st(this._touchMovePrev,e,i)};update(t,e,i){this.enabled&&(t!=this.camera&&(this.camera=t,t&&this.newCamera(t)),t&&(this.sceneVolume!==e&&(this.sceneVolume=e,e&&(this.newScene(e,t),!this.zoomTarget&&this.autoZoomToScene&&(this.zoomTarget=e))),this.zoomTarget&&(this.bringIntoView(this.zoomTarget,t),this.zoomTarget=void 0)),this.animate(i),this.output(this.outputPosition,this.outputRotation),t&&(D(t.position,this.outputPosition),et(t.rotation,this.outputRotation)))}zoomTo=t=>{this.zoomTarget=t};moveTo=(t,e)=>{};reset=()=>{this.camera&&this.newCamera(this.camera)};newScene(t,e){e.near=t.radius/5e3,e.far=10*t.radius}newCamera(t){}animate(t){}rotate(t,e){}pan(t,e,i){}orbit(t,e,i,s){}zoom(t,e,i){}}class ht extends ot{params={kind:"static",position:O(0,0,1),target:O(0,0,0),up:O(0,1,0)};constructor(t){super(),this.params={...this.params,...t}}bringIntoView(t,e){let i;switch(this.params.target=t.center,e.kind){case"pinhole":i=t.radius/Math.tan(k(e.fieldOfView)/2);break;case"orthographic":i=t.radius,e.fieldOfView=2*t.radius}if(i){const t=L();z(t,this.params.target,this.params.position);const e=1e-6;N(t,t)>e?U(t,t):W(t,0,0,1),I(t,t,i),j(this.params.position,this.params.target,t)}}output(t,e){const i=V(),s=x();var a,r;!function(t,e,i,s){var a=e[0],r=e[1],n=e[2],o=s[0],h=s[1],c=s[2],l=a-i[0],d=r-i[1],u=n-i[2],m=l*l+d*d+u*u;m>0&&(l*=m=1/Math.sqrt(m),d*=m,u*=m);var p=h*u-c*d,f=c*l-o*u,w=o*d-h*l;(m=p*p+f*f+w*w)>0&&(p*=m=1/Math.sqrt(m),f*=m,w*=m),t[0]=p,t[1]=f,t[2]=w,t[3]=0,t[4]=d*w-u*f,t[5]=u*p-l*w,t[6]=l*f-d*p,t[7]=0,t[8]=l,t[9]=d,t[10]=u,t[11]=0,t[12]=a,t[13]=r,t[14]=n,t[15]=1}(i,this.params.position,this.params.target,this.params.up),r=i,(a=s)[0]=r[0],a[1]=r[1],a[2]=r[2],a[3]=r[4],a[4]=r[5],a[5]=r[6],a[6]=r[8],a[7]=r[9],a[8]=r[10],tt(e,s),D(t,this.params.position)}}class ct extends ot{params={kind:"turntable",pivotPoint:O(0,0,0),distance:20,elevation:.5,rotation:0,rotationalVelocity:30};constructor(t){super(),this.params={...this.params,...t}}bringIntoView(t,e){switch(this.params.pivotPoint=t.center,e.kind){case"pinhole":this.params.distance=t.radius/Math.tan(k(e.fieldOfView)/2);break;case"orthographic":this.params.distance=t.radius,e.fieldOfView=2*t.radius}}animate(t){for(this.params.rotation+=this.params.rotationalVelocity*t;this.params.rotation>=360;)this.params.rotation-=360;for(;this.params.rotation<0;)this.params.rotation+=360}output(t,e){const i=k(this.params.rotation),s=Math.atan2(this.params.elevation,this.params.distance),a=Z();var r,n,o;J(a,a,i),Q(e,a,-s);const h=O(0,0,function(t){var e=t[0],i=t[1];return Math.hypot(e,i)}((r=this.params.elevation,n=this.params.distance,(o=new b(2))[0]=r,o[1]=n,o)));K(h,h,e),j(t,this.params.pivotPoint,h)}}class lt extends ot{params={kind:"orbit",pivotPoint:L(),distance:0,pitch:30,yaw:0,maxDistance:1e3,rotationalVelocity:.2,linearVelocity:.01};mouseButtonsMap={rotate:1,pan:2,orbit:0,pivot:0};constructor(t,e){super(e),this.params={...this.params,...t}}newCamera(t){const e=rt(t.rotation),{x:i,y:s}=nt(e);this.params.yaw=s*Math.PI/180,this.params.pitch=i*Math.PI/180,this.wrapYaw(),this.clampPitch()}wrapYaw(){for(;this.params.yaw>=360;)this.params.yaw-=360;for(;this.params.yaw<0;)this.params.yaw+=360}clampPitch(){this.params.pitch=at(this.params.pitch,-89,89)}clampDistance(){this.params.distance=at(this.params.distance,0,this.params.maxDistance)}bringIntoView(t,e){switch(this.params.pivotPoint=t.center,e.kind){case"pinhole":this.params.distance=t.radius/Math.tan(k(e.fieldOfView)/2);break;case"orthographic":this.params.distance=t.radius,e.fieldOfView=2*t.radius}}newScene(t,e){super.newScene(t,e),this.params.linearVelocity=t.radius/1e3,this.params.maxDistance=50*t.radius}output(t,e){const i=k(this.params.yaw),s=k(this.params.pitch),a=Z();J(a,a,i),Q(e,a,-s);const r=O(0,0,this.params.distance);K(r,r,e),j(t,this.params.pivotPoint,r)}rotate(t,e){this.params.yaw+=-t*this.params.rotationalVelocity,this.params.pitch+=e*this.params.rotationalVelocity,this.wrapYaw(),this.clampPitch()}pan(t,e,i){const s=O(-t*this.params.linearVelocity,0,0),a=O(0,e*this.params.linearVelocity,0),r=L();B(s,s,i),B(a,a,i),j(r,s,a),j(this.params.pivotPoint,this.params.pivotPoint,r)}zoom(t){this.params.distance+=t*this.params.linearVelocity,this.clampDistance()}}class dt extends ot{params={kind:"flight",position:L(),pivotPoint:!1,pitch:-30,yaw:30,linearVelocity:.03,autoZoomSpeed:!1,near:.1,far:5e3,flightTime:1,fieldOfView:60};distance;targetPosition=L();target_pitch=0;target_yaw=0;remainTime=-1;keys=new Set;constructor(t,e){super(e),this.params={...this.params,...t},D(this.outputPosition,this.params.position)}connect(){super.connect(),this.params.pivotPoint=!1,this.domElement.tabIndex=0,this.domElement.addEventListener("mousedown",this.handleMouseDown,!1),this.domElement.addEventListener("blur",this.blur,!1),this.domElement.addEventListener("keydown",this.keydown,!1),this.domElement.addEventListener("keyup",this.keyup,!1),this.domElement.addEventListener("touchstart",this._touchstart,!1),this.domElement.addEventListener("touchend",this._touchstart,!1)}disconnect(){super.disconnect(),this.domElement.removeEventListener("mousedown",this.handleMouseDown,!1),this.domElement.removeEventListener("blur",this.blur,!1),this.domElement.removeEventListener("keydown",this.keydown,!1),this.domElement.removeEventListener("keyup",this.keyup,!1),this.domElement.removeEventListener("touchstart",this._touchstart,!1),this.domElement.removeEventListener("touchend",this._touchstart,!1)}_touchstart=async t=>{const e=this.camera?.view;if(e&&this.enabled)if(t.stopPropagation(),this.pointerTable.length===this.fingersMap.pivot){let t=this.pointerTable[0].x,i=this.pointerTable[0].y;this.pointerTable.length>1&&(t=.5*(this.pointerTable[0].x+this.pointerTable[1].x),i=.5*(this.pointerTable[0].y+this.pointerTable[1].y)),await e.updatePickBuffers();const s=await e.pick(t*devicePixelRatio,i*devicePixelRatio);this.params.pivotPoint=s?.position??!1,this.params.pivotPoint?(this.distance=H(this.params.pivotPoint,this.params.position),(this.distance>this.params.far||this.distance>5e4)&&(this.distance=void 0,this.params.pivotPoint=!1)):this.distance=void 0}else this.params.pivotPoint=!1};handleMouseDown=async t=>{const e=this.camera?.view;if(e&&this.enabled&&(this.domElement.focus(),t.preventDefault(),this.distance=void 0,t.buttons&this.mouseButtonsMap.pivot)){await e.updatePickBuffers();const i=await e.pick(t.offsetX*devicePixelRatio,t.offsetY*devicePixelRatio);this.params.pivotPoint=i?.position??!1,this.params.pivotPoint?(this.distance=H(this.params.pivotPoint,this.params.position),(this.distance>this.params.far||this.distance>5e4)&&(this.distance=void 0,this.params.pivotPoint=!1)):this.distance=void 0}};zoomTo=t=>{if(this.camera&&this.enabled)if(0===this.params.flightTime)this.bringIntoView(t,this.camera);else{const e=Math.max(t.radius/Math.tan(k(this.camera.fieldOfView)/2),t.radius+this.params.near);this.output(L(),this.outputRotation),j(this.targetPosition,K(this.targetPosition,O(0,0,e),this.outputRotation),t.center),this.target_pitch=this.params.pitch,this.target_yaw=this.params.yaw,this.remainTime=this.params.flightTime,this.params.yaw+=.05}};moveTo=(t,e)=>{if(!this.enabled)return;D(this.targetPosition,t);const i=rt(e),{x:s,y:a}=nt(i);this.target_yaw=180*a/Math.PI,this.target_yaw>=360?this.target_yaw-=360:this.target_yaw<0&&(this.target_yaw+=360),this.target_pitch=at(180*s/Math.PI,-89,89),this.remainTime=this.params.flightTime,this.params.yaw+=.05};animate(t){if(this.enabled){if(this.camera&&this.params.near>0&&(this.camera.near=this.params.near),this.camera&&this.params.far>0&&(this.camera.far=this.params.far),this.camera&&this.params.fieldOfView>0&&this.mouseButtonsMap.pan>0&&(this.camera.fieldOfView=this.params.fieldOfView),(t<0||t>.25)&&(t=.01666666),this.remainTime>=0){if(t>=this.remainTime)this.params.yaw=this.target_yaw,this.params.pitch=this.target_pitch,D(this.params.position,this.targetPosition);else{const h=t/this.remainTime;e=this.params.position,i=this.params.position,s=this.targetPosition,a=h,r=i[0],n=i[1],o=i[2],e[0]=r+a*(s[0]-r),e[1]=n+a*(s[1]-n),e[2]=o+a*(s[2]-o);let c=this.target_yaw-this.params.yaw;c<-180?c+=360:c>180&&(c-=360),this.params.yaw+=c*h,this.params.pitch+=(this.target_pitch-this.params.pitch)*h,this.wrapYaw(),this.clampPitch()}this.remainTime-=t}var e,i,s,a,r,n,o;if(this.keys.size){let e=1;this.keys.has("ShiftLeft")&&(e*=2),this.keys.has("ShiftRight")&&(e*=2),this.keys.has("ControlLeft")&&(e*=5),this.keys.has("ControlRight")&&(e*=5),this.keys.has("AltLeft")&&(e*=.2),this.keys.has("AltRight")&&(e*=.2);let i=0,s=0,a=0,r=this.params.linearVelocity*t*100*e;if("pinhole"==this.camera?.kind&&this.mouseButtonsMap.pan>0?(this.keys.has("KeyW")&&(a-=r),this.keys.has("KeyS")&&(a+=r)):this.camera&&(this.keys.has("KeyW")&&(this.params.fieldOfView*=.95),this.keys.has("KeyS")&&(this.params.fieldOfView*=1.05)),this.mouseButtonsMap.pan>0&&(this.keys.has("KeyA")&&(i-=r),this.keys.has("KeyD")&&(i+=r),this.keys.has("KeyQ")&&(s-=r),this.keys.has("KeyE")&&(s+=r),0!=i||0!=s||0!=a)){const t=O(i,s,a);j(this.params.position,this.params.position,K(t,t,this.outputRotation))}let n=0,o=0,h=60*t;this.keys.has("ArrowUp")&&(n-=h),this.keys.has("ArrowDown")&&(n+=h),this.keys.has("ArrowLeft")&&(o+=h),this.keys.has("ArrowRight")&&(o-=h),0==n&&0==o||(this.params.yaw+=o,this.params.pitch+=n,this.wrapYaw(),this.clampPitch())}this.camera&&(this.camera.kind="pinhole")}}newCamera(t){}wrapYaw(){for(;this.params.yaw>=360;)this.params.yaw-=360;for(;this.params.yaw<0;)this.params.yaw+=360}clampPitch(){this.params.pitch=at(this.params.pitch,-89,89)}bringIntoView(t,e){switch(e.kind){case"pinhole":{const i=t.radius/Math.tan(k(e.fieldOfView)/2);this.output(L(),this.outputRotation),j(this.params.position,K(this.params.position,O(0,0,i),this.outputRotation),t.center);break}case"orthographic":e.fieldOfView=2*t.radius}}newScene(t,e){super.newScene(t,e),this.params.near>0&&(e.near=this.params.near),this.params.far>0&&(e.far=this.params.far),0===this.params.linearVelocity&&(this.params.linearVelocity=.03)}output(t,e){const i=k(this.params.yaw),s=k(this.params.pitch),a=Z();J(a,a,i),Q(e,a,s),D(t,this.params.position)}rotate(t,e){const i=this.domElement.clientHeight;this.params.yaw+=t*this.camera.fieldOfView/i,this.params.pitch+=e*this.camera.fieldOfView/i,this.wrapYaw(),this.clampPitch()}pan(t,e,i){const s=this.distance&&this.camera?.fieldOfView?this.distance*Math.tan(k(this.camera.fieldOfView))/this.domElement.clientHeight:this.params.linearVelocity,a=O(-t*s,0,0),r=O(0,e*s,0),n=L();B(a,a,i),B(r,r,i),j(n,a,r),j(this.params.position,this.params.position,n)}orbit(t,e,i,s){if(this.params.pivotPoint){const i=this.params.pitch,f=this.params.yaw;s?(e*=-5,t*=-5):(e*=5,t*=5);const w=L();Y(w,this.params.position,this.params.pivotPoint);const v=O(1,0,0);K(v,v,this.outputRotation),this.rotate(t,e),e=this.params.pitch-i,t=this.params.yaw-f;const g=Z(),y=Z();(function(t,e,i){i*=.5;var s=Math.sin(i);t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(i)})(g,v,k(e)),J(y,y,k(t));const b=Z();a=b,n=g,o=(r=y)[0],h=r[1],c=r[2],l=r[3],d=n[0],u=n[1],m=n[2],p=n[3],a[0]=o*p+l*d+h*m-c*u,a[1]=h*p+l*u+c*d-o*m,a[2]=c*p+l*m+o*u-h*d,a[3]=l*p-o*d-h*u-c*m;const M=S(x(),b);j(this.params.position,B(w,w,M),this.params.pivotPoint)}else this.pan(t,e,i);var a,r,n,o,h,c,l,d,u,m,p}zoom(t,e,i){const s=this.domElement.clientWidth,a=this.domElement.clientHeight;if("pinhole"==this.camera?.kind){const r=V();A(r,k(this.camera.fieldOfView),s/a,this.camera.near,this.camera.far);const n=O(2*e/s-1,1-2*i/a,0);P(r,r),q(n,n,r);const o=x();if(S(o,this.outputRotation),B(n,n,o),U(n,n),this.mouseButtonsMap.pan<1){const r=.001*t,n=Math.min(90,this.camera.fieldOfView*(1+r)),o=n-this.camera.fieldOfView;if(0===o)return;this.camera.fieldOfView=n;const h=o*(e-.5*s)/a,c=o*(i/a-.5);return this.params.yaw+=h,this.params.pitch+=c,this.wrapYaw(),void this.clampPitch()}let h=this.params.autoZoomSpeed&&this.distance?this.distance*Math.tan(k(this.camera.fieldOfView))/a:this.params.linearVelocity;this.keys.size&&(this.keys.has("ShiftLeft")&&(h*=2),this.keys.has("ShiftRight")&&(h*=2),this.keys.has("ControlLeft")&&(h*=5),this.keys.has("ControlRight")&&(h*=5),this.keys.has("AltLeft")&&(h*=.2),this.keys.has("AltRight")&&(h*=.2)),I(n,n,-t*h),j(this.params.position,this.params.position,n)}else if("orthographic"==this.camera?.kind){const r=t/500;if(this.params.fieldOfView*=1+r,t<0){const t=i/a-.5,r=O((e/s-.5)*this.params.fieldOfView,t*this.params.fieldOfView*-1,0);j(this.params.position,this.params.position,K(r,r,this.outputRotation))}}}blur=t=>{"exitPointerLock"in document&&document.exitPointerLock(),this.keys.clear()};keydown=t=>{switch(t.code){case"KeyW":case"KeyS":case"KeyA":case"KeyD":case"KeyQ":case"KeyE":t.preventDefault()}this.keys.add(t.code)};keyup=t=>{switch(t.code){case"KeyW":case"KeyS":case"KeyA":case"KeyD":case"KeyQ":case"KeyE":t.preventDefault()}this.keys.delete(t.code)}}class ut extends ot{params={kind:"ortho",referenceCoordSys:V(),position:L(),linearVelocity:.01,near:.1,far:5e3,fieldOfView:2};keys=new Set;update(t,e,i){super.update(t,e,i);const{params:s}=this;t&&(t.far=s.far,t.near=s.near)}constructor(t,e){super(e),this.params={...this.params,...t}}connect(){super.connect(),this.domElement.tabIndex=0,this.domElement.addEventListener("mousedown",this.handleMouseDown,!1),this.domElement.addEventListener("blur",this.blur,!1),this.domElement.addEventListener("keydown",this.keydown,!1),this.domElement.addEventListener("keyup",this.keyup,!1),this.domElement.addEventListener("touchstart",this._touchstart,!1),this.domElement.addEventListener("touchend",this._touchstart,!1)}disconnect(){super.disconnect(),this.domElement.removeEventListener("mousedown",this.handleMouseDown,!1),this.domElement.removeEventListener("blur",this.blur,!1),this.domElement.removeEventListener("keydown",this.keydown,!1),this.domElement.removeEventListener("keyup",this.keyup,!1),this.domElement.removeEventListener("touchstart",this._touchstart,!1),this.domElement.removeEventListener("touchend",this._touchstart,!1)}_touchstart=async t=>{const e=this.camera?.view;e&&t.stopPropagation()};handleMouseDown=async t=>{const e=this.camera?.view;e&&(this.domElement.focus(),t.preventDefault(),t.buttons,this.mouseButtonsMap.pivot)};zoomTo=t=>{this.camera&&this.bringIntoView(t,this.camera)};moveTo=(t,e)=>{if(!this.camera)return;const i=R(V(),e,t);this.params.referenceCoordSys=i,W(this.params.position,0,0,1)};animate(t){if(this.camera&&this.params.near>0&&(this.camera.near=this.params.near),this.camera&&this.params.far>0&&(this.camera.far=this.params.far),this.camera&&this.params.fieldOfView>0&&(this.camera.fieldOfView=this.params.fieldOfView),this.keys.size){let e=1;this.keys.has("ShiftLeft")&&(e*=2),this.keys.has("ShiftRight")&&(e*=2),this.keys.has("ControlLeft")&&(e*=5),this.keys.has("ControlRight")&&(e*=5),this.keys.has("AltLeft")&&(e*=.2),this.keys.has("AltRight")&&(e*=.2);let i=0,s=0,a=this.params.linearVelocity*t*100*e;if(this.camera&&(this.keys.has("KeyQ")&&(this.params.fieldOfView*=.99),this.keys.has("KeyE")&&(this.params.fieldOfView*=1.01)),this.keys.has("KeyA")&&(i-=a*this.params.fieldOfView),this.keys.has("KeyD")&&(i+=a*this.params.fieldOfView),this.keys.has("KeyW")&&(s+=a*this.params.fieldOfView),this.keys.has("KeyS")&&(s-=a*this.params.fieldOfView),this.keys.has("KeyR")&&(this.params.referenceCoordSys=T(V(),this.params.referenceCoordSys,Math.PI/128)),this.keys.has("KeyT")&&(this.params.referenceCoordSys=T(V(),this.params.referenceCoordSys,-Math.PI/128)),0!=i||0!=s){const t=O(i,s,0);j(this.params.position,this.params.position,t)}}this.camera&&(this.camera.kind="orthographic")}newCamera(t){}bringIntoView(t,e){e.fieldOfView=2*t.radius}newScene(t,e){super.newScene(t,e),this.params.near>0&&(e.near=this.params.near),this.params.far>0&&(e.far=this.params.far),0===this.params.linearVelocity&&(this.params.linearVelocity=t.radius/1e3)}output(t,e){const{position:i,referenceCoordSys:s}=this.params;!function(t,e){var i=new b(3);C(i,e);var s=1/i[0],a=1/i[1],r=1/i[2],n=e[0]*s,o=e[1]*a,h=e[2]*r,c=e[4]*s,l=e[5]*a,d=e[6]*r,u=e[8]*s,m=e[9]*a,p=e[10]*r,f=n+l+p,w=0;f>0?(w=2*Math.sqrt(f+1),t[3]=.25*w,t[0]=(d-m)/w,t[1]=(u-h)/w,t[2]=(o-c)/w):n>l&&n>p?(w=2*Math.sqrt(1+n-l-p),t[3]=(d-m)/w,t[0]=.25*w,t[1]=(o+c)/w,t[2]=(u+h)/w):l>p?(w=2*Math.sqrt(1+l-n-p),t[3]=(u-h)/w,t[0]=(o+c)/w,t[1]=.25*w,t[2]=(d+m)/w):(w=2*Math.sqrt(1+p-n-l),t[3]=(o-c)/w,t[0]=(u+h)/w,t[1]=(d+m)/w,t[2]=.25*w)}(e,s),q(t,i,s)}pan(t,e){const i=this.params.fieldOfView/this.domElement.clientHeight;j(this.params.position,this.params.position,O(-t*i,e*i,0))}zoom(t,e,i){const s=t/500;this.params.fieldOfView*=1+s}blur=t=>{"exitPointerLock"in document&&document.exitPointerLock(),this.keys.clear()};keydown=t=>{switch(t.code){case"KeyW":case"KeyS":case"KeyA":case"KeyD":case"KeyQ":case"KeyE":t.preventDefault()}this.keys.add(t.code)};keyup=t=>{switch(t.code){case"KeyW":case"KeyS":case"KeyA":case"KeyD":case"KeyQ":case"KeyE":t.preventDefault()}this.keys.delete(t.code)};init(t,e,i){const{params:s}=this;if(e){const n=(a=e,(r=new b(3))[0]=a[0],r[1]=a[1],r[2]=a[2],r),o=O(0,1,0);K(o,o,i.rotation);const h=F(L(),o,n);!function(t){const[e,i,s]=t;t[0]=t[1]=t[2]=0;const a=Math.abs(e),r=Math.abs(i),n=Math.abs(s);a>r&&a>n?t[0]=Math.sign(e):r>n?t[1]=Math.sign(i):t[2]=Math.sign(s)}(h),F(o,n,h),U(o,o),F(h,o,n),U(h,h);const c=function(t,e,i,s,a,r,n,o,h){var c=new b(9);return c[0]=t,c[1]=e,c[2]=i,c[3]=s,c[4]=a,c[5]=r,c[6]=n,c[7]=o,c[8]=h,c}(h[0],h[1],h[2],o[0],o[1],o[2],n[0],n[1],n[2]),l=tt(Z(),c),d=R(V(),l,t);s.referenceCoordSys=d,W(s.position,0,0,1)}else{const t=S(x(),i.rotation),e=i.position;s.referenceCoordSys=function(t,e,i,s,a,r,n,o,h,c,l,d,u,m,p,f){var w=new b(16);return w[0]=t,w[1]=e,w[2]=i,w[3]=0,w[4]=a,w[5]=r,w[6]=n,w[7]=0,w[8]=h,w[9]=c,w[10]=l,w[11]=0,w[12]=u,w[13]=m,w[14]=p,w[15]=1,w}(t[0],t[1],t[2],0,t[3],t[4],t[5],0,t[6],t[7],t[8],0,e[0],e[1],e[2])}var a,r;if(W(s.position,0,0,1),"pinhole"==i.kind){const e=i.getDistanceFromViewPlane(t),a=Math.max(.1,e)*Math.tan(Math.PI/180*i.fieldOfView/2)*2;s.fieldOfView=a}}}class mt{view;kind="pinhole";_controller=new ht({kind:"static"});position=L();rotation=Z();fieldOfView=45;near=.1;far=1e3;generation=0;previousState={position:L(),rotation:Z(),fieldOfView:0,near:0,far:0,kind:"pinhole"};viewClipMatrix=V();viewWorldMatrix=V();viewFrustum={left:X(),right:X(),top:X(),bottom:X(),near:X(),far:X(),image:X()};constructor(t){this.view=t}get controller(){return this._controller}set controller(t){this._controller!=t&&(this._controller.disconnect(),this._controller=t,this._controller.connect())}getDistanceFromViewPlane(t){const{position:e,rotation:i}=this,s=O(0,0,-1);K(s,s,i);const a=-N(s,e);return N(t,s)+a}update(t){const{position:e,rotation:i,fieldOfView:s,generation:a}=this;this.updateState();const{viewClipMatrix:r,viewWorldMatrix:n,viewFrustum:o}=this;if("orthographic"==this.kind){const a=s/2,h=a*t;(function(t,e,i,s,a,r,n){var o=1/(e-i),h=1/(s-a),c=1/(r-n);t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+i)*o,t[13]=(a+s)*h,t[14]=(n+r)*c,t[15]=1})(r,-h,h,-a,a,this.near,this.far),R(n,i,e);const{left:c,right:l,top:d,bottom:u,near:m,far:p,image:f}=o;$(c,-1,0,0,h),$(l,1,0,0,h),$(d,0,1,0,a),$(u,0,-1,0,a),$(m,0,0,1,-this.near),$(p,0,0,-1,this.far),$(f,0,0,-1,0)}else{A(r,k(s),t,this.near,this.far),R(n,i,e);const a=k(s/2),h=Math.atan(Math.tan(a)*t),{left:c,right:l,top:d,bottom:u,near:m,far:p,image:f}=o;$(c,-Math.cos(h),0,Math.sin(h),0),$(l,Math.cos(h),0,Math.sin(h),0),$(d,0,Math.cos(a),Math.sin(a),0),$(u,0,-Math.cos(a),Math.sin(a),0),$(m,0,0,1,-this.near),$(p,0,0,-1,this.far),$(f,0,0,-1,0)}return{generation:a,viewFrustum:o,viewClipMatrix:r,viewWorldMatrix:n}}get hasChanged(){const{previousState:t}=this;return e=t.position,i=this.position,!(e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2]&&function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}(t.rotation,this.rotation)&&_(t.fieldOfView,this.fieldOfView)&&_(t.near,this.near)&&_(t.far,this.far)&&t.kind==this.kind);var e,i}updateState(){const{hasChanged:t}=this;if(t){const{previousState:t}=this;D(t.position,this.position),et(t.rotation,this.rotation),t.fieldOfView=this.fieldOfView,t.near=this.near,t.far=this.far,t.kind=this.kind,this.generation++}return t}}var pt;function ft(t,e){return 4*t+e}!function(t){t[t.Model=0]="Model",t[t.World=1]="World",t[t.View=2]="View",t[t.Clip=3]="Clip"}(pt||(pt={}));const wt=[0,0,0],vt=[0,0,0];function gt(t){return{modelWorldMatrix:t.getMatrix(pt.Model,pt.World),modelViewMatrix:t.getMatrix(pt.Model,pt.View),modelClipMatrix:t.getMatrix(pt.Model,pt.Clip),clipViewMatrix:t.getMatrix(pt.Clip,pt.View),clipWorldMatrix:t.getMatrix(pt.Clip,pt.World),clipModelMatrix:t.getMatrix(pt.Clip,pt.Model),worldViewMatrix:t.getMatrix(pt.World,pt.View),worldClipMatrix:t.getMatrix(pt.World,pt.Clip),viewWorldMatrix:t.getMatrix(pt.View,pt.World),viewModelMatrix:t.getMatrix(pt.View,pt.Model),viewClipMatrix:t.getMatrix(pt.View,pt.Clip),worldModelMatrix:t.getMatrix(pt.World,pt.Model)}}function yt(t){return{modelWorldNormalMatrix:t.getMatrixNormal(pt.Model,pt.World),modelViewNormalMatrix:t.getMatrixNormal(pt.Model,pt.View),modelClipNormalMatrix:t.getMatrixNormal(pt.Model,pt.Clip),clipViewNormalMatrix:t.getMatrixNormal(pt.Clip,pt.View),clipWorldNormalMatrix:t.getMatrixNormal(pt.Clip,pt.World),clipModelNormalMatrix:t.getMatrixNormal(pt.Clip,pt.Model),worldViewNormalMatrix:t.getMatrixNormal(pt.World,pt.View),worldClipNormalMatrix:t.getMatrixNormal(pt.World,pt.Clip),viewWorldNormalMatrix:t.getMatrixNormal(pt.View,pt.World),viewModelNormalMatrix:t.getMatrixNormal(pt.View,pt.Model),viewClipNormalMatrix:t.getMatrixNormal(pt.View,pt.Clip),worldModelNormalMatrix:t.getMatrixNormal(pt.World,pt.Model)}}class bt{_mtx4=new Array(16);_mtx3=new Array(16);constructor(t,e,i){this._mtx4[ft(pt.Model,pt.World)]=t,this._mtx4[ft(pt.View,pt.World)]=e,this._mtx4[ft(pt.View,pt.Clip)]=i;const s=this._mtx4[ft(pt.World,pt.Model)]=V(),a=this._mtx4[ft(pt.World,pt.View)]=V(),r=this._mtx4[ft(pt.Clip,pt.View)]=V();P(s,t),P(a,e),P(r,i)}getMatrix(t,e){const i=ft(t,e);let s=this._mtx4[i];return s||(this._mtx4[i]=s=V(),e>t?E(s,this.getMatrix(e-1,e),this.getMatrix(t,e-1)):E(s,this.getMatrix(t-1,e),this.getMatrix(t,t-1))),s}getMatrixNormal(t,e){const i=ft(t,e);let s=this._mtx3[i];var a,r,n,o,h,c,l,d,u,m,p,f,w,v,g,y,b,M,k,_,S,V,P,E,T,R,C,A,L,O,D;return s||(this._mtx3[i]=s=x(),a=s,n=(r=this.getMatrix(t,e))[0],o=r[1],h=r[2],c=r[3],l=r[4],d=r[5],u=r[6],m=r[7],p=r[8],f=r[9],w=r[10],v=r[11],g=r[12],y=r[13],b=r[14],(D=(k=n*d-o*l)*(O=w*(M=r[15])-v*b)-(_=n*u-h*l)*(L=f*M-v*y)+(S=n*m-c*l)*(A=f*b-w*y)+(V=o*u-h*d)*(C=p*M-v*g)-(P=o*m-c*d)*(R=p*b-w*g)+(E=h*m-c*u)*(T=p*y-f*g))&&(D=1/D,a[0]=(d*O-u*L+m*A)*D,a[1]=(u*C-l*O-m*R)*D,a[2]=(l*L-d*C+m*T)*D,a[3]=(h*L-o*O-c*A)*D,a[4]=(n*O-h*C+c*R)*D,a[5]=(o*C-n*L-c*T)*D,a[6]=(y*E-b*P+M*V)*D,a[7]=(b*S-g*E-M*_)*D,a[8]=(g*P-y*S+M*k)*D)),s}}const Mt=.05;class kt{view;deviceProfile;_nodeSize=-100;_timers=[];_maxTriangles=navigator.userAgent.match(/Android/i)?performance.memory.jsHeapSizeLimit<1073741824?5e6:1e7:navigator.userAgent.match(/Intel Mac OS/i)?1e7:navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)?5e6:15e6;tolerance=[25,20];highTolerance=navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/Intel Mac OS/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)?[45,40]:[55,50];_state=-1;_allowUp=!0;constructor(t,e){this.view=t,this.deviceProfile=e}get active(){return 2!==this._state}_capWait=0;setValue(t){const{quality:e}=this.view.settings;this.view.applySettings({quality:{detail:{value:Math.pow(10,t),autoAdjust:e.detail.autoAdjust},resolution:e.resolution}})}update(t,e,i){const s=this.view.settings,{detail:a}=s.quality,{autoAdjust:r}=a;if(!r?.enabled)return;let n=Math.log10(a.value).toFixed(2);if(this._nodeSize<-10&&(this._nodeSize=+n),!s.diagnostics.holdDynamic){if(e.triangles+e.points/2>this.deviceProfile.triangleLimit){const t=+n+Mt;return t>this._nodeSize&&(this._nodeSize=t),n=t.toFixed(2),this.setValue(+n),e.renderResolved=!1,this._state=2,void(this._timers.length=0)}if(!(t>1e3)){if(this._timers.push(t),i)this._allowUp=!0,this._state=0,n!==this._nodeSize.toFixed(2)&&this.setValue(this._nodeSize);else{if(!this._allowUp||this._state>1){if(!e.renderResolved)return;if(2===this._state||!e.sceneResolved)return;const t=+n;return this._state=2,void(t>+r.min.toFixed(2)&&(n=(+n-Mt).toFixed(2),e.sceneResolved=!1,e.renderResolved=!1,this.setValue(+n),this._state=3))}if(!e.renderResolved||!e.sceneResolved)return}if(this._state<2&&e.renderResolved){let t=0;for(let e of this._timers)t+=e;if(this._timers.length<20)return;t=1e3*this._timers.length/t;const i=[this.deviceProfile.targetFPS,this.deviceProfile.targetFPS+5];this._allowUp&&t>i[0]?e.sceneResolved&&(this._state=-1,this._nodeSize-=Mt):t<i[1]?(this._nodeSize+=Mt,this._allowUp=!1,this._state=1):this._state=0}this._timers=[],this._nodeSize<r.min?(this._nodeSize=r.min,this._state=2):this._nodeSize>r.max&&(this._nodeSize=r.max,this._state=0),n!==this._nodeSize.toFixed(2)&&(e.sceneResolved=!1,e.renderResolved=!1,this.setValue(this._nodeSize))}}}}class _t{view;_enabled=!1;step=.1;_targetWidth=0;_targetHeight=0;_curStep=0;_timers=[[],[]];_weak=!0;tolerance=[30,25];wasDown=!1;wasUp=!1;lastDT=0;calmCount=0;constructor(t){this.view=t}get active(){return this._enabled}setValue(t){const{quality:e}=this.view.settings;this.view.applySettings({quality:{resolution:{value:t,autoAdjust:e.resolution.autoAdjust},detail:e.detail}})}update(t,e,i,s,a){const r=this.view.settings,{resolution:n}=r.quality,{autoAdjust:o}=n,h=o.max;if(!o?.enabled)return this._enabled=!1,void this.setValue(h);if(i){this.calmCount=0,this._enabled=!0,this.wasDown=!1,this.wasUp=!1;const t=h-this.step*this._curStep;n.value!==t&&this.setValue(t)}else if(!this._enabled||!s)return this._enabled=!1,void this.setValue(h);if(t>2e3)return;const c=this._timers[a?1:0];if(c.push(t),c.length<25)return;t=0;for(let e of c)t+=e;t=2*t/c.length;const l=c.filter((e=>e<t));t=0;for(let e of l)t+=e;t=1e3*l.length/t;const d=(h-Math.max(.2,o.min))/this.step;this._curStep>0&&t>this.tolerance[0]?(this._curStep--,this.calmCount=0,this.wasUp=!0):t<this.tolerance[1]&&this._curStep<d&&!this.wasUp?(e.renderResolved&&(this.lastDT=t,this._curStep=Math.ceil((h-n.value*Math.sqrt(t/this.tolerance[1]))/this.step),this.wasDown=!0),this.calmCount=0):(this.calmCount++,this._enabled=this.calmCount<4),this.setValue(h-this.step*this._curStep),c.length=0}setSize(t,e,i){const{autoAdjust:s}=i.quality.resolution;if(void 0===s||!s.enabled||t===this._targetWidth&&e===this._targetHeight)return;const a=s.max;this.wasDown=!1,this.lastDT=0,this.calmCount=0,this._targetWidth/t<.3&&(this._curStep=Math.round((a-(t>1280?1280/t:i.quality.resolution.value))/this.step),this.setValue(a-this.step*this._curStep)),this._targetWidth=t,this._targetHeight=e,this._timers=[[],[]]}}class xt{itemRefs=[];add(t){const e=(i=t,"WeakRef"in self?new WeakRef(i):{[Symbol.toStringTag]:"WeakRef",deref:()=>i});var i;this.itemRefs.push(e)}remove(t){const e=this.itemRefs.findIndex((e=>e.deref()==t));this.itemRefs.splice(e,1)}*[Symbol.iterator](){const{itemRefs:t}=this,e=[];for(let i=0;i<t.length;i++){const s=t[i].deref();s?yield s:e.push(i)}e.reverse();for(const i of e)t.splice(i,1)}}function St(t){if("object"!=typeof t||null===t)return t;let e;const i=t.constructor;switch(i){case RegExp:e=new RegExp(t);break;case Date:e=new Date(t.getTime());break;default:e=i?new i:Object.create(null)}for(var s in t){const i=t[s];"function"!=typeof i&&(e[s]=St(i))}return e}const Vt=Symbol("scope");function Pt(t,...e){for(const i of e)if(void 0!==i)for(const e of Reflect.ownKeys(i))void 0!==t[e]&&(`#${e.toString()}`in t||t[e]!==Object(t[e])?Reflect.set(t,e,i[e]):Pt(t[e],i[e]))}function Et(t){return Reflect.defineProperty(t,Vt,{enumerable:!1}),t}class Tt{onChange;proxy;constructor(t,e){this.onChange=t,this.proxy=e??Object.create(null)}wrap(t){for(let e in t){const i=t[e];"object"==typeof i&&Vt in i?this.scope(e,i):this.mutable(e,i)}}mutable(t,e){const{proxy:i,onChange:s}=this;"object"==typeof e&&(e=Array.isArray(e)?[...e]:{...e},Object.seal(e));const a=`#${t.toString()}`;Reflect.defineProperty(i,a,{enumerable:!1,value:e,writable:!0}),Reflect.defineProperty(i,t,{enumerable:!0,get:function(){return this[a]},set:function(t){this[a]!=t&&(this[a]=t,s())}})}scope(t,e){const{proxy:i,onChange:s}=this,a=new Tt(s);a.wrap(e),Reflect.defineProperty(i,t,{enumerable:!0,writable:!1,value:a.proxy})}}const Rt={display:Et({width:150,height:100}),grid:Et({enabled:!1,majorLineCount:21,minorLineCount:0,origo:L(),axisX:O(1,0,0),axisY:O(0,1,0),majorColor:[.5,1,.5],minorColor:[1,.5,.5]}),background:Et({color:[0,0,.25,1]}),clippingPlanes:Et({enabled:!1,inside:!0,showBox:!1,bounds:Et({min:L(),max:L()}),highlight:0}),clippingVolume:Et({enabled:!1,mode:"union",planes:[]}),environment:void 0,exposure:0,light:Et({ambient:{brightness:.1},camera:Et({brightness:0,distance:10}),sun:Et({brightness:1,position:Et({azimuth:135,inclination:45})})}),objectHighlights:[],points:Et({shape:"disc",size:Et({pixel:1,maxPixel:void 0,metric:0,toleranceFactor:0}),deviation:Et({mode:"mix",colors:[{deviation:-1,color:[1,0,0,1]},{deviation:-.5,color:[1,1,0,1]},{deviation:-.45,color:[1,1,0,0]},{deviation:.45,color:[1,1,0,0]},{deviation:.5,color:[1,1,0,1]},{deviation:1,color:[0,1,0,1]}]}),intensity:Et({mode:"mix",colors:[{intensity:0,color:[1,0,0,0]},{intensity:.5,color:[1,1,0,.5]},{intensity:1,color:[0,1,0,1]}]})}),ocean:Et({enabled:!1,color:[.5,.5,1],opacity:.5}),quality:Et({detail:Et({value:1,autoAdjust:Et({enabled:!0,min:-1,max:1}),maxLodTriangles:Number.MAX_SAFE_INTEGER,maxLodTextureBytes:Number.MAX_SAFE_INTEGER}),resolution:Et({value:1,autoAdjust:Et({enabled:!0,min:.2,max:1})})}),terrain:Et({elevationColors:[{elevation:-10,color:[0,0,.5]},{elevation:0,color:[.5,.5,1]},{elevation:0,color:[0,.5,0]},{elevation:10,color:[.5,1,.5]}],asBackground:!1}),advanced:Et({doubleSided:Et({opaque:!1,transparent:!1}),hideTerrain:!1,hidePoints:!1,hideTriangles:!1,hideLines:!1,hideDocuments:!1}),diagnostics:Et({maxQueueSize:8,holdDynamic:!1,showBoundingBoxes:!1}),outline:Et({enable:!1,color:void 0})};class Ct{view;camera;renderSettings;statistics;workerView;_gotImage=!1;constructor(t,e,i){this.view=t,this.camera=e,this.renderSettings=i,this.workerView=t.workerView,this.statistics=St(t.performanceStatistics)}get viewWorldMatrix(){return this.camera?.viewWorldMatrix??V()}get worldViewMatrix(){return this.camera?.worldViewMatrix??V()}get viewClipMatrix(){return this.camera?.viewClipMatrix??V()}get worldClipMatrix(){return this.camera?.worldClipMatrix??V()}async pick(t,e){if(this.camera){const{renderSettings:i}=this,s=i.quality.resolution.value;return await this.workerView.pick(t*s,e*s)}}async measure(t,e){if(this.camera){const{renderSettings:i}=this,s=i.quality.resolution.value;return await this.workerView.measure(t*s,e*s)}}async applyPostEffect(t){return this._gotImage||"ssao"!==t.kind||(this.view.usedSSAO=!0),await this.workerView.applyPostEffect(t)}async getImage(){const t=await this.workerView.getOutputImage();return this._gotImage=!0,t}dispose(){}get hasViewChanged(){const{view:t,renderSettings:e,camera:i}=this,s=e.generation!=t.settings.generation||t._TB.active&&e.quality.detail.autoAdjust.enabled||t._autoFps.active&&e.quality.resolution.autoAdjust.enabled||(i?.generation??0)!=t.camera.generation||t.scene?.generation!==t.prevGens.scene||t.camera.hasChanged||!t.performanceStatistics.sceneResolved||t.workerViewHasPendingChanges;return s||t.dropTime(),s}}b=Array;class At{api;workerView;_scene;_sceneViewState;_renderViewInitialized=Promise.resolve();_modelWorldMatrix=V();_noupdates=!1;_TB;_autoFps;disposed=!1;camera;settings=function(){const t=Object.create(null);return t.generation=0,new Tt((()=>{t.generation++}),t).wrap(Rt),t}();performanceStatistics={cpuTime:{animation:0,render:{draw:0,update:0,total:0},geometry:{update:0}},triangles:0,points:0,drawCalls:0,sceneResolved:!1,renderResolved:!1,weakDevice:!0,cameraGeneration:0};autoRender=!0;workerViewHasPendingChanges=!1;generation=0;prevGens={camera:0,settings:0,scene:0};constructor(t,e,i){this.api=t,this.workerView=e,i&&this.applySettings(i),this.performanceStatistics.weakDevice=!t.deviceProfile.renderFullResolution,this.camera=new mt(this),this._TB=new kt(this,t.deviceProfile),this._autoFps=new _t(this);const s=f((t=>{this.workerViewHasPendingChanges=t}));e.setPendingChangesCallback(s)}isRenderResolvedChecking=!1;isSceneResolvedChecking=!1;checkRenderResolved(){this.performanceStatistics.renderResolved||this.isRenderResolvedChecking||(this.isRenderResolvedChecking=!0,this.workerView.fullyResolved.then((t=>{this.performanceStatistics.renderResolved=!0})).catch().finally((()=>{this.isRenderResolvedChecking=!1})))}checkSceneResolved(){this.performanceStatistics.sceneResolved||this.isSceneResolvedChecking||!this._sceneViewState||(this.isSceneResolvedChecking=!0,this._sceneViewState.fullyResolved.then((t=>{this.performanceStatistics.sceneResolved=!0})).catch().finally((()=>{this.isSceneResolvedChecking=!1})))}applySettings(t){const{settings:e}=this;t.quality?.resolution?.autoAdjust.max&&(t.quality.resolution.autoAdjust.max=Math.min(this.api.deviceProfile.renderFullResolution?1:1/devicePixelRatio,t.quality.resolution.autoAdjust.max),t.quality.resolution.value>t.quality.resolution.autoAdjust.max&&(t.quality.resolution.value=t.quality.resolution.autoAdjust.max)),e.generation,Pt(e,t)}async setScene(t){if(this._scene=t,t){const{config:s}=t;e=this._modelWorldMatrix,i=s.modelWorldMatrix??V(),e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15]}else!function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(this._modelWorldMatrix);var e,i;this._sceneViewState&&(await this._sceneViewState.dispose(),this._sceneViewState=void 0),t&&(this._sceneViewState=await t.createViewState(this.workerView,this.api.deviceProfile),this.performanceStatistics.sceneResolved=!1,this.performanceStatistics.renderResolved=!1,this.isRenderResolvedChecking=!1,this.isSceneResolvedChecking=!1,this.checkSceneResolved(),this._TB=new kt(this,this.api.deviceProfile),this._autoFps=new _t(this))}get scene(){return this._scene}set scene(t){this._scene!=t&&(this._renderViewInitialized=this.setScene(t))}async dispose(){this.disposed||(this.disposed=!0,this._sceneViewState&&await this._sceneViewState.dispose(),this.workerView&&(await this.workerView.dispose(),this.workerView[s]()))}computeCameraValues(){const{camera:t,settings:e}=this;if(t){const i=e.quality.resolution.value;let{width:s,height:a}=e.display;s*=i,a*=i;const r=s/a,{generation:n,viewFrustum:o,viewClipMatrix:h,viewWorldMatrix:c}=t.update(r);return function(t,e,i,s,a,r,n,o){const h=new bt(t,e,i);return function(t,e,i){var s,a;(s=vt)[0]=(a=e)[12],s[1]=a[13],s[2]=a[14];const{left:r,right:n,top:o,bottom:h,near:c,far:l,image:d}=t,u=[r,n,o,h,c,l,d];for(const t of u){const[e,s,a,r]=t;W(wt,e,s,a),B(wt,wt,i);const n=r+N(vt,wt);$(t,wt[0],wt[1],wt[2],-n)}}(s,h.getMatrix(pt.View,pt.Model),h.getMatrixNormal(pt.View,pt.Model)),{generation:a,viewFrustum:s,width:r,height:n,...gt(h),...yt(h),projection:o}}(this._modelWorldMatrix,c,h,o,n,s,a,t.kind)}}update(){const{camera:t}=this;if(t){const{controller:e}=t;if(void 0!==e){const i=performance.now();e.update(t,this._scene?.boundingSphere,.001*(i-this.controllerLastTime)),this.controllerLastTime=i}}}lastRenderStartTime=0;usedSSAO=!1;dropTime(){this.lastRenderStartTime=0}async render(t){const{camera:e,performanceStatistics:i,prevGens:s}=this;for(;;){const{sceneResolved:a}=i;if(await this.api.waitFrame(),this.update(),e&&(s.camera!==e.generation||e.hasChanged)||s.settings!==this.settings.generation||s.scene!==this._scene?.generation||this._TB.active&&this.settings.quality.detail.autoAdjust.enabled||this._autoFps.active&&this.settings.quality.resolution.autoAdjust.enabled||!a||this.workerViewHasPendingChanges){s.camera=e.generation,s.settings=this.settings.generation,s.scene=this._scene?.generation??0;break}this.lastRenderStartTime=0,t&&t()}const a=this.computeCameraValues(),r=function(t){return St(t)}(this.settings),{holdDynamic:n}=r.diagnostics;if(a&&!n){const t=this._sceneViewState;if(t){const e=await t.update(a,r);i.cpuTime.geometry.update=e.updateTime,i.sceneResolved=e.resolved}}const{width:o,height:h}=r.display;await this._renderViewInitialized;const{workerView:c}=this;this._autoFps.setSize(o,h,r);const l=performance.now();if(this.lastRenderStartTime>0){const t=l-this.lastRenderStartTime;this.performanceStatistics.cpuTime.render.total=t;const e=this.lastGeneration!==i.cameraGeneration;e&&(this.lastMoveTime=l);const s=l-this.lastMoveTime<1e3;this.lastGeneration=i.cameraGeneration,this._TB.update(t,this.performanceStatistics,e),this._autoFps.update(t,this.performanceStatistics,e,s,this.usedSSAO)}else this.performanceStatistics.cpuTime.render.total=0;this.lastRenderStartTime=l,this.usedSSAO=!1;const d=await c.render(a,r,this.generation++);return i.cpuTime.render.draw=d.drawTime,i.cpuTime.render.update=d.updateTime,i.drawCalls=d.drawcalls,i.triangles=d.triangles,i.points=d.points,i.cameraGeneration=a?.generation??0,this.checkSceneResolved(),this.checkRenderResolved(),new Ct(this,a,r)}lastMoveTime=0;controllerLastTime=0;lastGeneration=0;get fullyResolved(){return(async()=>{await this.workerView.fullyResolved,await this.api.waitFrame()})()}async transferToImageBitmap(){return await this.workerView.transferToImageBitmap()}async convertToBlob(t){return await this.workerView.convertToBlob(t)}async updatePickBuffers(){if(this.computeCameraValues()){const{settings:t}=this;t.quality.resolution.value,await this.workerView.updatePickBuffers()}}async pick(t,e){if(this.computeCameraValues()){const{settings:i}=this,s=i.quality.resolution.value;return await this.workerView.pick(t*s,e*s)}}async measure(t,e){if(this.computeCameraValues()){const{settings:i}=this,s=i.quality.resolution.value;return await this.workerView.measure(t*s,e*s)}}}const Lt={cube:[new class{id;name;path;type;constructor(t,e,i,s){this.id=t,this.name=e,this.path=i,this.type=s}description;url;properties=[];loadMetaData(){return Promise.resolve(this)}save(){return Promise.resolve(!1)}}(0,"cube","cube",1)]},Ot={empty:{kind:"empty",id:"empty",version:"",boundingSphere:{center:L(),radius:1},modelWorldMatrix:V(),materials:[],db:"empty"},cube:{kind:"cube",id:"cube",version:"",count:1,radius:0,boundingSphere:{center:L(),radius:0+Math.sqrt(3)},modelWorldMatrix:V(),materials:[{kind:"basic_z",uniforms:{color:O(1,0,0)}},{kind:"basic_z",uniforms:{color:O(1,1,0)}},{kind:"basic_z",uniforms:{color:O(0,1,0)}},{kind:"basic_z",uniforms:{color:O(0,1,1)}},{kind:"basic_z",uniforms:{color:O(0,0,1)}},{kind:"basic_z",uniforms:{color:O(1,0,1)}}],db:"cube"}};function Dt(t,e){const i=("string"==typeof e?[e]:e).map((t=>new RegExp(t,"i")));if(i.some((e=>e.test(t.name))))return!0;const{path:s}=t,a=s.split("/");if(i.some((t=>t.test(a[a.length-1])))||t.description&&i.some((e=>e.test(t.description))))return!0;const{properties:r}=t;if(void 0!==r)for(let t of r)if(i.some((e=>e.test(t[0])))||i.some((e=>e.test(t[1]))))return!0;return!1}function Wt(t,e){if(t.name===e)return!0;const{path:i}=t,s=i.split("/");if(s[s.length-1]===e||t.description===e)return!0;const{properties:a}=t;if(void 0!==a)for(let t of a)if(t[0]===e||t[1]===e)return!0;return!1}async function*jt(t,e){let i=e.parentPath??"",s=0,a=e.descentDepth??1e5;if(i.length>0)s=i.split("/").length-1,a>0?(i+="/",a+=s,t=t.filter((t=>t.level>s&&t.level<=a&&t.path.startsWith(i)))):t=t.filter((t=>t.level===s&&t.path===i));else{if(0===a)return;t=t.filter((t=>t.level<a))}const{searchPattern:r}=e;if(r)if(Array.isArray(r)){for(const{property:e,value:i,exact:s}of r)if(void 0!==i)if(e)if(s)t=t.filter((t=>{for(const s of t.properties)if(s[0]===e&&s[1]===i)return!0;return!1}));else{const s=new RegExp(e,"i"),a=("string"==typeof i?[i]:i).map((t=>new RegExp(t,"i")));t=t.filter((t=>{for(const e of t.properties)if(s.test(e[0])&&a.some((t=>t.test(e[1]))))return!0;return!1}))}else t=s?t.filter((t=>Wt(t,i))):t.filter((t=>Dt(t,i)))}else t=t.filter((t=>Dt(t,r)));yield*t.sort(((t,e)=>(0===t.type?-2:0)+(0===e.type?2:0)+(t.path>e.path?1:-1)))}class zt{db;loadMetaData(){return Promise.resolve(this)}save(){return Promise.resolve(!1)}constructor(t){this.db=t,t.forEach(((t,e)=>{t.loadMetaData=this.loadMetaData,t.save=this.save}))}search(t,e){return jt(this.db,t)}getObjectMetdata(t){return Promise.resolve(this.db[t])}}async function*It(t,e){const i=await fetch(t.toString(),{signal:e});if(!i.ok)throw new Error(`Failed to retreive scene metadata: ${i.status} ${i.statusText}`);if(i.body){const t=i.body.getReader(),e=new TextDecoder("utf-8");let{value:s,done:a}=await t.read(),r=s?e.decode(s):"",n=/\r\n|\n|\r/gm,o=0;for(;;){let i=n.exec(r);if(i)yield r.substring(o,i.index),o=n.lastIndex;else{if(a)break;let i=r.substr(o);({value:s,done:a}=await t.read()),r=i+(s?e.decode(s):""),o=n.lastIndex=0}}o<r.length&&(yield r.substr(o))}}class Ht{url;loadMetaData(){return Promise.resolve(this)}save(){return Promise.resolve(!1)}_promise;constructor(t){this.url=t}async getDB(t){if(!this._promise){const e=new URL(this.url);e.pathname+="metadata",this._promise=async function(t,e,i,s){let a=[];const r=It(t,s);for await(const t of r){const s=JSON.parse(t);s.loadMetaData=e,s.save=i,a.push(s)}return a}(e,this.loadMetaData,this.save,t)}return this._promise}search(t,e){return async function*(t,e){const i=await t;for await(const t of jt(i,e))yield t}(this.getDB(e),t)}async getObjectMetdata(t){return(await this.getDB())[t]}}class Ut{objectHighlightIndices;generation=0;constructor(t){this.objectHighlightIndices=new Uint8Array(t)}async commit(){this.generation++}}!function(t){t.empty=new t(0)}(Ut||(Ut={}));class Nt{assetUrl;config;db;workerAssets;createWorkerScene;title="";dateCreated=new Date(Date.now());dateLastSaved=new Date(Date.now());description="";location;timezone;_highlighter;instances=[];boundingSphere;id;get subtrees(){return this.config.subtrees}get variants(){return this.config.variants}_generation=0;get generation(){return this._generation}constructor(t,e,i,s,a){this.assetUrl=t,this.config=e,this.db=i,this.workerAssets=s,this.createWorkerScene=a,this.id=e.id;const{center:r,radius:n}=e.boundingSphere,o=O(1,1,1);e.modelWorldMatrix&&(C(o,e.modelWorldMatrix),q(r,r,e.modelWorldMatrix)),this.boundingSphere={center:r,radius:n*o[0]}}async createViewState(t,e){const{config:s,assetUrl:a}=this,r=await this.createWorkerScene(),n=await t[i](),o=await r.initialize(p(n,[n]),e,s,a);return o&&(D(this.boundingSphere.center,o.center),this.boundingSphere.radius=o.radius),new Nt.ViewState(this,r)}get dynamicObjects(){const{instances:t}=this;return function*(){for(let e of t)e&&(yield e)}()}getObjectReference(t){return{id:t,loadMetaData:()=>this.db.getObjectMetdata(t)}}search(t,e){return this.db.search(t,e)}async descendants(t,e){if(!t.descendants)try{const i=new URL(this.assetUrl);i.pathname+=`descendants/${t.id}`;const s=[],a=It(i,e);for await(const t of a)s.push(parseInt(t));t.descendants=s}catch{t.descendants=[]}return t.descendants??[]}computeSunPosition(t){if(!this.location)return{azimuth:0,inclination:0};function e(t){return Math.sin(t*Math.PI/180)}function i(t){return 180*Math.asin(t)/Math.PI}function s(t){return Math.cos(t*Math.PI/180)}function a(t){return 180*Math.acos(Math.max(-1,Math.min(1,t)))/Math.PI}const r=Math.floor((t.getTime()-new Date(t.getFullYear(),0,1).getTime())/864e5),n=t.getHours()+t.getMinutes()/60+this.location.longitude/15-(this.timezone??0),o=15*n-90,h=-i(.39779*s(.98565*(r+10)+1.914*e(.98565*(r-2)))),c=i(e(this.location.latitude)*e(h)+e(o)*s(this.location.latitude)*s(h));let l;return l=this.location.latitude<90&&this.location.latitude>-90?a((e(h)-s(90-c)*e(this.location.latitude))/(e(90-c)*s(this.location.latitude))):a(s(15*n)*s(h)/e(90-c)),{azimuth:n>12||n<0?360-l:l,inclination:c}}createDynamicObject(t){const{instances:e}=this,i=e.length,s=new Ft(t,(()=>{this._generation++}),(()=>{e[i]=void 0}));return e[i]=s,s}get objectHighlighter(){if(!this._highlighter){const{config:t}=this;function e(t){return"octree"==t.kind}if(!e(t))return Ut.empty;{const{numObjects:i}=t;this._highlighter=new Ut(i)}}return this._highlighter}}!function(t){t.ViewState=class{scene;workerScene;_prevHighlighterGeneration=-1;_prevObjectHighlights;constructor(t,e){this.scene=t,this.workerScene=e,this._prevObjectHighlights=Rt.objectHighlights}async dispose(){await this.workerScene.dispose(),this.workerScene[s]()}async update(t,e){const i=this.scene.instances.map((t=>{if(t){const{visible:e,position:i,rotation:s,scale:a,geometry:r}=t;return{assetId:r.id,visible:e,position:i,rotation:s,scale:a}}})),s=this.scene._highlighter;let a;if(s&&this._prevHighlighterGeneration!=s.generation&&(this._prevHighlighterGeneration=s.generation,a=s.objectHighlightIndices.buffer),this._prevObjectHighlights!=e.objectHighlights)this._prevObjectHighlights=e.objectHighlights;else{const{objectHighlights:t,...i}=e;e=i}return await this.workerScene.update(t,i,a,e)}get fullyResolved(){return(async()=>{await this.workerScene.fullyResolved})()}}}(Nt||(Nt={}));class Ft{geometry;updated;remove;_visible=!1;_position=L();_rotation=Z();_scale=O(1,1,1);get visible(){return this._visible}get position(){return this._position}get rotation(){return this._rotation}get scale(){return this._scale}set visible(t){t!==this._visible&&(this._visible=t,this.updated())}set position(t){G(t,this._position)||(this._position=t,this.updated())}set rotation(t){(function(t,e){var i=t[0],s=t[1],a=t[2],r=t[3],n=e[0],o=e[1],h=e[2],c=e[3];return Math.abs(i-n)<=y*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(s-o)<=y*Math.max(1,Math.abs(s),Math.abs(o))&&Math.abs(a-h)<=y*Math.max(1,Math.abs(a),Math.abs(h))&&Math.abs(r-c)<=y*Math.max(1,Math.abs(r),Math.abs(c))})(t,this._rotation)||(this._rotation=t,this.updated())}set scale(t){G(t,this._scale)||(this._scale=t,this.updated())}constructor(t,e,i){this.geometry=t,this.updated=e,this.remove=i}dispose(){this.remove()}}const qt=document.currentScript?.src??("undefined"==typeof document&&"undefined"==typeof location?new(require("url").URL)("file:"+__filename).href:"undefined"==typeof document?location.href:document.currentScript&&document.currentScript.src||new URL("index_umd.js",document.baseURI).href);async function Bt(t){const e=new Image;e.crossOrigin="anonymous";const i=new Promise(((i,s)=>{e.addEventListener("load",(()=>{const t=document.createElement("canvas"),{width:s,height:a}=e;t.width=s,t.height=a;const r=t.getContext("2d",{alpha:!0,desynchronized:!1});r.drawImage(e,0,0);const n=r.getImageData(0,0,s,a);i(n)}),!1),e.addEventListener("error",(()=>{s(`Failed to download image: ${t}`)}))}));return e.src=t,i}function Kt(t){let e=1,i=0;return function(t){return"object"==typeof t}(t)?(t.scale&&(e=t.scale),t.offset&&(i=t.offset)):"number"==typeof t&&(e=0,i=t),[e,i]}class Gt{url;id;boundingSphere;remove;constructor(t,e,i,s){this.url=t,this.id=e,this.boundingSphere=i,this.remove=s}dispose(){this.remove()}}class Yt{assetsUrl;webGL1Only;version;scriptUrl;run=!0;animate;supportsOffscreenCanvas="OffscreenCanvas"in self;animHandle;dynamicAssets=[];environments=[];views=new xt;workerAssets;deviceProfile;workers;constructor(t,e,i){this.assetsUrl=t,this.webGL1Only=e;const s=new URL(qt);this.scriptUrl=new URL("./",s).href.slice(0,-1),this.version="0.3.130",i&&(this.supportsOffscreenCanvas=!1),this.deviceProfile=function(){const t=document.createElement("CANVAS");t.width=1,t.height=1,document.body.appendChild(t);const e=t.getContext("webgl",{failIfMajorPerformanceCaveat:!0});t.remove();let i="unknown",s=!1,a=null==e,r=!1,n=.25,o=40,h=.25,c=5e6,l=5e6;const d=e?.getExtension("WEBGL_debug_renderer_info"),u=d?e?.getParameter(37446):"???",{userAgent:m}=navigator,p=/\bMobile\b/.test(m);return/\bWindows\b/.test(m)?(i="windows",a||(n=1,r=!1,c=2e7,l=1e7,o=50,h=1,/\bNVIDIA|Radeon\b/.test(u)&&(s=!0,r=!0,c=2e7,l=5e7,h=1.5))):/\bMacintosh\b/.test(m)?p?a||(i="ipad",o=40,n=.5,r=!1,h=.5,c=5e6,l=5e6):(i="mac",a||(o=50,n=1,r=!1,h=1,c=2e7,l=1e7)):/\biPad/.test(m)?(i="ipad",a||(o=40,n=.5,r=!1,h=.5,c=5e6,l=5e6)):/\biPhone/.test(m)?i="ios":/\bbAndroid\b/.test(m)&&(i="android",p||a||(o=40,n=.5,r=!1,h=.5,c=5e6,l=5e6)),{name:i,hasMajorPerformanceCaveat:a,discreteGPU:s,targetFPS:o,detailBias:h,renderFullResolution:r,textureResolution:n,triangleLimit:c,textureBytesLimit:l}}()}async createWorkers(){const t=(t,e)=>{if(this.scriptUrl.startsWith(self.location.origin))return new Worker(t,{type:"classic",name:e});{const i=new Blob([`importScripts(${JSON.stringify(t)});`],{type:"text/javascript"}),s=URL.createObjectURL(i),a=new Worker(s,{type:"classic",name:e});return URL.revokeObjectURL(s),a}},e=this.supportsOffscreenCanvas?t(`${this.scriptUrl}/render.js`,"Render"):(t=>{const{port1:e,port2:i}=new MessageChannel;return import(t).then((t=>{const{__initRenderServiceEndPoint__:e}=self;e(i),delete self.__initRenderServiceEndPoint__}),(t=>{throw new t})),e})(`${this.scriptUrl}/render.js`),i=t(`${this.scriptUrl}/geometry.js`,"Geometry"),s=c(e),a=c(i);this.workers={render:{worker:e,service:s},geometry:{worker:i,service:a}};const r=await s.materialTypes;this.workerAssets=await a.initialize(r,this.scriptUrl,this.supportsOffscreenCanvas?void 0:f(Bt)),this.animHandle=requestAnimationFrame(this.animateCB)}async dispose(){this.run=!1,this.animHandle&&(cancelAnimationFrame(this.animHandle),this.animHandle=void 0);for(const t of this.views)await t.dispose();const{workers:t}=this;if(t){const{render:e,geometry:i}=t;await i.service.terminate(),await e.service.terminate(),i.service[s](),e.service[s](),this.workers=void 0}}resolves=[];animateCB=async t=>{this.run&&(this.animate?.(t),this.internalUpdate());for(const t of this.resolves)t(void 0);this.resolves.length=0,this.animHandle=requestAnimationFrame(this.animateCB)};async waitFrame(){const t=new Promise((t=>{this.resolves.push(t)}));await t}internalUpdate(){const t=[];for(const e of this.views)e.disposed?t.push(e):e.update();for(const e of t)this.views.remove(e)}async update(){await this.internalUpdate(),await this.waitFrame()}async loadScene(t,e){return this.workers||await this.createWorkers(),"string"!=typeof t&&(t=t.toString()),async function(t,e,i){let s=Ot[e];if(s)e=location.origin;else{const t=new URL(e);t.pathname+="config.json",s=await async function(t){const e=await fetch(t);if(!e.ok)throw new Error(e.statusText);return await e.json()}(t.toString())}const a=Lt[s.id],r=i??(a?new zt(a):new Ht(e)),{assets:n,createScene:o}=await t.createAssets(e);return new Nt(e,s,r,n,o)}(this.workers.geometry.service,t,e)}async loadAsset(t){this.workers||await this.createWorkers();const{dynamicAssets:e,workerAssets:i}=this,s=e.length;e[s]=void 0;const a=await i.loadAsset(s,t.toString());return e[s]=new Gt(t,s,a,(async()=>{await i.disposeAsset(s),e[s]=void 0}))}async loadEnvironment(t){this.workers||await this.createWorkers();const{environments:e,workerAssets:i}=this,s=e.length;return e[s]=void 0,await i.loadEnvironment(s,t.url),e[s]={id:s,dispose:async()=>{await i.disposeEnvironment(s),e[s]=void 0}}}async createView(t,e){this.workers||await this.createWorkers();const i=await async function(t,e,i,s,a){const r=i?.quality?.resolution.value??1,n=i?.display?.width??300*r,o=i?.display?.height??150*r;self.__htmlRenderCanvas__=a;const h=await e.createView(n,o,s);return delete self.__htmlRenderCanvas__,new At(t,h,i)}(this,this.workers.render.service,t,this.webGL1Only,e);return this.views.add(i),i}createNeutralHighlight(){return{rgbaTransform:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0]}}createTransparentHighlight(t){return{rgbaTransform:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,t,0]}}createColorSetHighlight(t){const[e,i,s,a]=t;return{rgbaTransform:[0,0,0,0,e,0,0,0,0,i,0,0,0,0,s,0,0,0,0,a??1]}}createRGBATransformHighlight(t){const e=Kt(t.red),i=Kt(t.green),s=Kt(t.blue),a=Kt(t.opacity);return{rgbaTransform:[e[0],0,0,0,e[1],0,i[0],0,0,i[1],0,0,s[0],0,s[1],0,0,0,a[0],a[1]]}}createHSLATransformHighlight(t){const[e,i]=Kt(t.lightness),[s,a]=Kt(t.opacity);function r(t,e,i){return t+(e-t)*i}const n=t.saturation??1,o=r(1/3,1,n)*e,h=r(1/3,0,n)*e;return{rgbaTransform:[o,h,h,0,i,h,o,h,0,i,h,h,o,0,i,0,0,0,s,a]}}createHighlight(t){switch(t.kind){case"neutral":return this.createNeutralHighlight();case"transparent":return this.createTransparentHighlight(t.opacity);case"color":return this.createColorSetHighlight(t.color);case"rgba":return this.createRGBATransformHighlight(t);case"hsla":return this.createHSLATransformHighlight(t);default:{function e(t){throw new Error("Unknown highlight type {$params.kind}!")}return e()}}}createCameraController(t,e){switch(t.kind){case"static":return new ht(t);case"turntable":return new ct(t);case"orbit":return new lt(t,e);case"flight":return new dt(t,e);case"ortho":return new ut(t,e);default:{function i(t){throw new Error("Unknown controller type {$params.kind}!")}return i()}}}async availableEnvironments(t){let e=[];const i=new URL(t??"/assets/env/index.json",qt),s=await fetch(i.toString());return s.ok&&(e=(await s.json()).map((t=>({name:t,url:new URL(t,i).toString(),thumnbnailURL:new URL(`thumbnails/${t}.png`,i).toString()})))),e}}var Xt,$t;t.WellKnownSceneUrls=void 0,(Xt=t.WellKnownSceneUrls||(t.WellKnownSceneUrls={})).empty="empty",Xt.cube="cube",Xt.oilrig="https://blobs.novorender.com/9fb7bdf8ae8445189573681194718db8/",Xt.condos="https://blobs.novorender.com/1169297611ae33f63132f264ed34e265/",t.NodeType=void 0,($t=t.NodeType||(t.NodeType={}))[$t.Internal=0]="Internal",$t[$t.Leaf=1]="Leaf",t.API=Yt,t.createAPI=function(t){return new Yt(t?.assetsUrl??"https://blobs.novorender.com",t?.webGL1Only??!1,t?.noOffscreenCanvas??!1)},Object.defineProperty(t,"__esModule",{value:!0})}));